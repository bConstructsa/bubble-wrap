# TODO: replace with global properties
global:
    labels:
        - &text_fill          black
        - &text_stroke [0.870,0.870,0.870]      # land color
        - &townspot_sprite   townspot-m-rev     # depends on land color and text settings
        - &text_font_family  'Open Sans'        # branding in asperational Unicode, yo (or Helvetica)

    labels-global:
        - &text_visible_continent         true
        - &text_visible_admin             true
        - &text_visible_populated_places  true
        - &icon_visible_populated_places  true
        - &text_visible_neighbourhoods    true
        - &text_visible_neighbourhoods_e  true

layers:
   places:
        data: { source: osm, layer: places }
        filter: { not: { kind: [ocean, sea] } }
        draw:
            text-blend-order:
                visible: false    # labels are enabled by each layer below
                font:
                    family: *text_font_family
                    # weight: 500
                    fill: *text_fill

        continent:
            filter: { name: true, kind: [continent], $zoom: {max: 5} }
            draw:
                text-blend-order:
                    visible: *text_visible_continent
                    font:
                        size: 14px
                        weight: 700
                        # stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase

        country-z2:
            filter:
                all:
                    - kind: [country]
                    - $zoom: [2]
                    - name: ["United States of America","Brasil","中华人民共和国","Россия","Canada","Kalaallit Nunaat","Ísland","Australia","India","日本","Guam","Indonesia","South Africa","مصر","Nigeria","Kenya"]
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        fill: [0.30,0.30,0.30]
                        weight: 400
                        size: 10px
                        transform: uppercase
        country-z3:
            filter: { name: true, population: true, kind: [country], $zoom: [3] }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        fill: [0.20,0.20,0.20]
                        size: 11px
                        weight: 600
                        # stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase
    #            icons:
    #                size: [[13, 12px], [15, 18px]]
    #                interactive: true
    #                sprite: *townspot_sprite
            early-ones:
                # US, Brazil, China, Russia, Canada, Greenland, Iceland, Australia, India, Japan, Guam, Indonesia, South Africa, Egypt, Nigeria, Kenya
                filter: { not: { name: ["United States of America","Brasil","中华人民共和国","Россия","Canada","Kalaallit Nunaat","Ísland","Australia","India","日本","Guam","Indonesia","South Africa","مصر","Nigeria","Kenya"] }, $zoom: {min: 3, max: 4} }
                draw:
                    text-blend-order:
                        visible: false
        country-z4:
            filter: { name: true, population: true, kind: [country], $zoom: [4] }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        size: 12px
                        weight: 600
                        fill: [0.40,0.40,0.40]
                        # stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase
    #            icons:
    #                size: [[13, 12px], [15, 18px]]
    #                interactive: true
    #                sprite: *townspot_sprite
            early-ones-z4:
                filter: { name: [Nederland,Luxembourg,Liechtenstein,San Marino,Civitatis Vaticanæ,Crna Gora,Македонија,The Gambia,Burundi,Swaziland,الإمارات العربية المتحدة,العراق,Singapore,El Salvador,Belize,Trinidad and Tobago, Saint Lucia, Montserrat,Anguilla,República Dominicana,Bahamas,British Virgin Islands,Antigua and Barbuda,Grenada,Sint Maarten,Saint Kitts and Nevis,Cayman Islands,België - Belgique - Belgien], $zoom: {min: 4, max: 5} }
                draw:
                    text-blend-order:
                        visible: false
        country-z5:
            filter:
                all:
                    - name: true
                    - population: true
                    - kind: [country]
                    - $zoom: [5]
                any:
                    - { population: { min: 5000000 } }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        size: 13px
                        weight: 400
                        fill: [0.25,0.25,0.25]
                        # stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase
    #            icons:
    #                size: [[13, 12px], [15, 18px]]
    #                interactive: true
    #                sprite: *townspot_sprite
            early-ones-z5:
                filter: { name: [Luxembourg,Liechtenstein,San Marino,Civitatis Vaticanæ,El Salvador,Belize,België - Belgique - Belgien], $zoom: {min: 5, max: 6} }
                draw:
                    text-blend-order:
                        visible: false
        country-z6:
            # South Ossetia and Abkhazia aren't countries (they are disputed areas)
            filter: { name: true, kind: [country], $zoom: [6] }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        size: 14px
                        weight: 600
                        fill: [0.25,0.25,0.25]
                        # stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase
            small-ones-z6:
                filter: { name: [Luxembourg,Liechtenstein,San Marino,Civitatis Vaticanæ,België - Belgique - Belgien,Хуссар Ирыстон,Аҧсны - Абхазия], $zoom: {min: 6, max: 7} }
                draw:
                    text-blend-order:
                        visible: false
        country-z7:
            # South Ossetia and Abkhazia aren't countries (they are disputed areas)
            filter: { name: true, kind: [country], $zoom: { min: 7, max: 9 } }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        size: 16px
                        weight: 600
                        fill: [0.25,0.25,0.25]
                        # stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase
            small-ones-z7:
                filter: { name: [Liechtenstein,San Marino,Civitatis Vaticanæ,Хуссар Ирыстон,Аҧсны - Абхазия], $zoom: {min: 7, max: 8} }
                draw:
                    text-blend-order:
                        visible: false

        region-z4:
            filter: { name: true, kind: [state], $zoom: [4], not: { name: ["Western Cape","Eastern Cape","Northern Cape","North West","Limpopo","KwaZulu-Natal","Hamburg","Freie und Hansestadt Hamburg","Neuchâtel","Nordrhein-Westfalen","Haute-Normandie","Baden-Württemberg","Bayern","Sachsen-Anhalt","Berlin","Mecklenburg-Vorpommern","Schleswig-Holstein","Brandenburg","Niedersachsen","Saarland","Thüringen","Hessen","Sachsen"] } }
            draw:
                text-blend-order:
                    priority: 14
                    visible: *text_visible_admin
                    text_source: 'name:short'
                    font:
                        size: 10px
                        weight: 300
                        fill: [0.3,0.3,0.3]

        region-z5:
            filter: { name: true, kind: [state], $zoom: [5], not: { name: ["Western Cape","Eastern Cape","Northern Cape","North West","Limpopo","KwaZulu-Natal","Hamburg","Freie und Hansestadt Hamburg","Neuchâtel","Nordrhein-Westfalen","Haute-Normandie","Baden-Württemberg","Bayern","Sachsen-Anhalt","Berlin","Mecklenburg-Vorpommern","Schleswig-Holstein","Brandenburg","Niedersachsen","Saarland","Thüringen","Hessen","Sachsen"] } }
            draw:
                text-blend-order:
                    priority: 14
                    visible: *text_visible_admin
                    text_source: 'name:short'
                    font:
                        size: 13px
                        weight: 300
                        fill: [0.3,0.3,0.3]

        region-z6:
            filter: { name: true, kind: [state], $zoom: [6], not: { name: ["Western Cape","Eastern Cape","Northern Cape","North West","Limpopo","KwaZulu-Natal","Hamburg","Freie und Hansestadt Hamburg","Neuchâtel","Nordrhein-Westfalen","Haute-Normandie","Baden-Württemberg","Bayern","Sachsen-Anhalt","Berlin","Mecklenburg-Vorpommern","Schleswig-Holstein","Brandenburg","Niedersachsen","Saarland","Thüringen","Hessen","Sachsen"] } }
            draw:
                text-blend-order:
                    priority: 14
                    visible: *text_visible_admin
                    text_source: 'name:short'
                    font:
                        size: 15px
                        weight: 300
                        fill: [0.4,0.4,0.4]

        region:
            filter: { name: true, kind: [state], $zoom: {min: 7, max: 9} }
            draw:
                text-blend-order:
                    priority: 14
                    visible: *text_visible_admin
                    text_source: function() { if(feature["name:short"]) { return feature["name"]; } else { return ""; } }
                    font:
                        size: 14px
                        weight: 300
                        fill: [0.3,0.3,0.3]
                        #stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase
    #            icons:
    #                size: [[13, 12px], [15, 18px]]
    #                interactive: true
    #                sprite: *townspot_sprite
            pesky:
                filter: { name: ["Western Cape","Eastern Cape","Northern Cape","North West","Limpopo","KwaZulu-Natal","Hamburg","Freie und Hansestadt Hamburg","Neuchâtel","Nordrhein-Westfalen","Haute-Normandie","Baden-Württemberg","Bayern","Sachsen-Anhalt","Berlin","Mecklenburg-Vorpommern","Schleswig-Holstein","Brandenburg","Niedersachsen","Saarland","Thüringen","Hessen","Sachsen"], $zoom: {min: 7, max: 8} }
                draw:
                    text-blend-order:
                        visible: false
            small-ones:
                filter: { name: ["Delaware","New Jersey","Connecticut","Rhode Island","Massachusetts","New Hampshire","Vermont"], $zoom: {min: 7, max: 8} }
                draw:
                    text-blend-order:
                        text_source: function() { return feature["name:abbreviation"] || feature["name"]; }
                        font: { transform: uppercase }

        populated-places:
            draw:
                icons:
                    interactive: true
                    priority: 5
                text-blend-order:
                    interactive: true
                    anchor: bottom
                    priority: 6

            populated-places-natural-earth-z2:
                filter: { name: true, source: naturalearthdata.com, $zoom: [2], scalerank: 0 }
                draw:
                    text-blend-order:
                        visible: *text_visible_populated_places
                        offset: [0, 3px] # half icon size
                        font:
                            size: 10px
                            fill: *text_fill
                            # stroke: { color: *text_stroke, width: 4 }
                    icons:
                        size: 5px
                        visible: *icon_visible_populated_places
                        sprite: townspot-s-rev

            populated-places-natural-earth-z3:
                filter: { name: true, source: naturalearthdata.com, $zoom: [3] }
                z3places-1:
                    filter: { scalerank: [0] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            font:
                                size: 11px
                                fill: *text_fill
                                # stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            sprite: townspot-s-rev
                z3places-2:
                    filter: { scalerank: [1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 9px
                                fill: *text_fill
                                # stroke: { color: *text_stroke, width: 4 }
                        icons:
                            priority: 7
                            size: 5px
                            sprite: townspot-s-rev

            populated-places-natural-earth-z4:
                filter: { name: true, source: naturalearthdata.com, $zoom: [4] }
                z4places-1:
                    filter: { scalerank: [0] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            font:
                                size: 13px
                                fill: *text_fill
                                # stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev

                z4places-2:
                    filter: { scalerank: [1,2] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 10px
                                fill: *text_fill
                                # stroke: { color: *text_stroke, width: 4 }
                        icons:
                            priority: 7
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev

            populated-places-natural-earth-z5:
                filter: { name: true, source: naturalearthdata.com, $zoom: [5] }
                z5places-1:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 13px
                        icons:
                            priority: 7
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 6
                            icons:
                                priority: 5
                                size: 8px
                                sprite: capital-l

                z5places-2:
                    filter: { scalerank: [2] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                size: 11px
                        icons:
                            priority: 11
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 10
                            icons:
                                priority: 9
                                size: 6px
                                sprite: capital-m

                z5places-3:
                    filter: { scalerank: [3,4] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 18
                            font:
                                fill: [0.25,0.25,0.25]
                                size: 10px
                        icons:
                            priority: 17
                            size: 5px
                            sprite: townspot-s-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 16
                            icons:
                                priority: 15
                                size: 6px
                                sprite: capital-m

            populated-places-natural-earth-z6:
                filter: { name: true, source: naturalearthdata.com, $zoom: [6] }
                z6places-1:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 4px] # half icon size
                            priority: 8
                            font:
                                fill: *text_fill
                                size: 15px
                        icons:
                            priority: 7
                            size: 8px
                            visible: *icon_visible_populated_places
                            sprite: townspot-l-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 6
                            icons:
                                sprite: capital-l
                                size: 8px
                                priority: 5

                z6places-2:
                    filter: { scalerank: [2,3,4] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                fill: *text_fill
                                size: 12px
                        icons:
                            priority: 11
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 10
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 9

                z6places-3:
                    filter: { scalerank: [5,6] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 16
                            font:
                                fill: [0.25,0.25,0.25]
                                size: 10px
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 15
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 14
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 13

            populated-places-natural-earth-z7:
                filter: { name: true, source: naturalearthdata.com, $zoom: [7] }
                z7places-1:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 4px] # half icon size
                            priority: 8
                            font:
                                fill: *text_fill
                                size: 16px
                        icons:
                            size: 8px
                            visible: *icon_visible_populated_places
                            sprite: townspot-l-rev
                            priority: 7
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 6
                            icons:
                                size: 8px
                                sprite: capital-l
                                priority: 5

                z7places-2:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 14
                            font:
                                fill: *text_fill
                                size: 13px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 13
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 12
                            icons:
                                size: 8px
                                sprite: capital-l
                                priority: 11

                z7places-3:
                    filter: { scalerank: [6,7] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 18
                            font:
                                fill: [0.25,0.25,0.25]
                                size: 11px
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 17
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 16
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 15

            populated-places-osm-z8:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [8]

                z8places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 16px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 7
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 6
                            icons:
                                size: 8px
                                sprite: capital-l
                                priority: 5
                z8places-2:
                    filter:
                        any:
                            - { population: { min: 150000, max: 999999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                size: 13px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 11
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 10
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 9

                z8places-3:
                    filter:
                        any:
                            - { population: { min: 85000, max: 149999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 16
                            font:
                                fill: [0.25,0.25,0.25]
                                size: 11px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 15
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 14
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 13

                z8places-4:
                    filter:
                        any:
                            - { population: { min: 50000, max: 84999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 20
                            font:
                                fill: [0.30,0.30,0.30]
                                size: 10px
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 19
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 18
                            icons:
                                size: 5px
                                sprite: capital-m
                                priority: 17
                z8places-5:
                    filter:
                        all:
                            - { population: { max: 50000 } }
                        any:
                            - { capital: yes }
                            - { state_capital: yes }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 20
                            font:
                                fill: [0.30,0.30,0.30]
                                size: 10px
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 19
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 18
                            icons:
                                size: 5px
                                sprite: capital-s
                                priority: 17

            populated-places-natural-earth-z8-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [8], population: { max: 50000 } }
                draw: { text-blend-order: { font: { fill: *text_fill } } }
                z8places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 4px] # half icon size
                            priority: 24
                            font:
                                size: 16px
                        icons:
                            size: 8px
                            visible: *icon_visible_populated_places
                            sprite: townspot-l-rev
                            priority: 23
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 22
                            icons:
                                size: 8px
                                sprite: capital-l
                                priority: 21

                z8places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            font:
                                size: 13px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            icons:
                                sprite: capital-m

                z8places-3-ne:
                    filter: { scalerank: [6,7] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 28
                            font:
                                size: 11px
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 27
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 26
                            icons:
                                sprite: capital-s
                                priority: 25

            populated-places-osm-z9:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [9]

                z9places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }
                    draw:
                        text-blend-order:
                            anchor: center
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 17px

                z9places-2a:
                    filter:
                        any:
                            - { population: { min: 350000, max: 999999 } }
                    draw:
                        text-blend-order:
                            anchor: center
                            visible: *text_visible_populated_places
                            priority: 8
                            font:
                                size: 13px

                z9places-2b:
                    filter:
                        any:
                            - { population: { min: 150000, max: 350000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                size: 13px
                        icons:
                            size: 6px
                            sprite: townspot-m-rev
                            priority: 11
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 10
                            icons:
                                sprite: capital-m
                                priority: 9

                z9places-3:
                    filter:
                        any:
                            - { population: { min: 85000, max: 149999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 16
                            font:
                                fill: [0.25,0.25,0.25]
                                size: 11px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 15
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 14
                                font:
                                    size: 15px
                            icons:
                                sprite: capital-m
                                priority: 13

                z9places-4:
                    filter:
                        any:
                            - { population: { min: 50000, max: 84999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 20
                            font:
                                fill: [0.30,0.30,0.30]
                                size: 9px
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 19
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 18
                            icons:
                                sprite: capital-s
                                priority: 17
                z9places-5:
                    filter:
                        all:
                            - { population: { max: 50000 } }
                        any:
                            - { capital: yes }
                            - { state_capital: yes }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 20
                            font:
                                fill: [0.30,0.30,0.30]
                                size: 9px
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 19
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 18
                            icons:
                                sprite: capital-s
                                priority: 17

            populated-places-osm-z9-no-population:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [9]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        visible: *text_visible_populated_places
                        offset: [0, 3px] # half icon size
                        priority: 22
                        font:
                            size: 10px
                    icons:
                        size: 5px
                        visible: *icon_visible_populated_places
                        sprite: townspot-s-rev
                        priority: 21

            populated-places-natural-earth-z9-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [9], population: { max: 50000 } }
                draw: { text-blend-order: { font: { fill: *text_fill } } }
                z9places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 4px] # half icon size
                            priority: 26
                            font:
                                size: 16px
                        icons:
                            size: 8px
                            visible: *icon_visible_populated_places
                            sprite: townspot-l-rev
                            priority: 25
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 24
                            icons:
                                sprite: capital-l
                                priority: 23

                z9places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 30
                            font:
                                size: 13px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 29
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 27
                            icons:
                                sprite: capital-m
                                priority: 28

                z9places-3-ne:
                    filter: { scalerank: [6,7,8,9] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 34
                            font:
                                size: 11px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 33
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 32
                            icons:
                                sprite: capital-m
                                priority: 31

            populated-places-osm-z10:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [10]

                z10places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }
                    draw:
                        text-blend-order:
                            anchor: center
                            visible: *text_visible_populated_places
                            priority: 5
                            font:
                                size: 17px

                z10places-2a:
                    filter:
                        any:
                            - { population: { min: 350000, max: 1000000 } }
                    draw:
                        text-blend-order:
                            anchor: center
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 13px

                z10places-2b:
                    filter:
                        any:
                            - { population: { min: 150000, max: 350000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 13px
                        icons:
                            size: 6px
                            sprite: townspot-m-rev
                            priority: 7

                z10places-3:
                    filter:
                        any:
                            - { population: { min: 50000, max: 149999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                fill: [0.25,0.25,0.25]
                                size: 11px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 11

                z10places-4:
                    filter:
                        any:
                            - { population: { min: 20000, max: 49999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 14
                            font:
                                fill: [0.35,0.35,0.35]
                                size: 9px
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 13

            populated-places-osm-z10-no-population:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [10]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        visible: *text_visible_populated_places
                        offset: [0, 3px] # half icon size
                        priority: 16
                        font:
                            size: 10px
                    icons:
                        size: 5px
                        visible: *icon_visible_populated_places
                        sprite: townspot-s-rev
                        priority: 15

            populated-places-natural-earth-z10-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [10], population: { max: 20000 } }
                draw: { text-blend-order: { font: { fill: *text_fill } } }
                z10places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 2px] # half icon size
                            priority: 17
                            font:
                                size: 16px

                z10places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 22
                            font:
                                size: 13px
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 21
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 21
                            icons:
                                sprite: capital-m
                                priority: 20

                z10places-3-ne:
                    filter: { scalerank: [6,7,8,9,10] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 26
                            font:
                                size: 12px
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 25
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 24
                            icons:
                                size: 7px
                                sprite: capital-m
                                priority: 23

            populated-places-osm-z11:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [11]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center

                z11places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 5
                            font:
                                size: 18px

                z11places-2:
                    filter:
                        any:
                            - { population: { min: 50000, max: 999999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 14px

                z11places-3:
                    filter:
                        any:
                        - { population: { min: 5000, max: 49999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 7
                            font:
                                size: 12px

            populated-places-osm-z11-no-population:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [11]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center
                        visible: *text_visible_populated_places
                        priority: 8
                        font:
                            size: 11px

            populated-places-natural-earth-z11-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [11], population: { max: 5000 } }
                draw:
                    text-blend-order:
                        anchor: center
                        font:
                            fill: *text_fill
                z11places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 10
                            font:
                                size: 16px
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 9
                                font:
                                    size: 16px

                z11places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 13
                            font:
                                size: 13px
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 11
                                font:
                                    size: 16px
                    state_capital:
                        filter: { state_capital: yes }
                        draw:
                            text-blend-order:
                                priority: 12
                                font:
                                    size: 14px

                z11places-3-ne:
                    filter: { scalerank: [6,7,8,9,10,11] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 15
                            font:
                                size: 11px
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 14
                                font:
                                    size: 14px

            populated-places-osm-z12:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [12]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center

                z12places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }

                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 5
                            font:
                                size: 18px

                z12places-2:
                    filter:
                        any:
                            - { population: { min: 50000, max: 999999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 14px

                z12places-3:
                    filter:
                        any:
                        - { population: { min: 5000, max: 49999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 7
                            font:
                                size: 11px

                z12places-4:
                    filter:
                        any:
                        - { population: { max: 5000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 8
                            font:
                                size: 10px

            populated-places-osm-z12-no-population:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [12]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center
                        visible: *text_visible_populated_places
                        priority: 9
                        font:
                            size: 11px

            populated-places-natural-earth-z12-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [12], population: { max: 5000 } }
                draw:
                    text-blend-order:
                        anchor: center
                        priority: 10
                        font:
                            fill: *text_fill

                z12places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 12
                            font:
                                size: 16px
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 11
                                font:
                                    size: 16px

                z12places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 14
                            font:
                                size: 13px
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 13
                                font:
                                    size: 16px

                z12places-3-ne:
                    filter: { scalerank: [6,7,8,9,10,11,12] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 16
                            font:
                                size: 11px
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 15
                                font:
                                    size: 14px

            populated-places-osm-z13-z14:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [13,14]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center
                        visible: *text_visible_populated_places
                        font:
                            weight: 600
                            fill: *text_fill
                z14:
                    filter:
                        $zoom: [14]
                    draw:
                        text-blend-order:
                            font:
                                weight: 600

                z13places-1:
                    filter:
                        any:
                            - { population: { min: 200000 } }
                    draw:
                        text-blend-order:
                            visible: false

                z13places-2:
                    filter:
                        any:
                            - { population: { min: 50000, max: 199999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 5
                            font:
                                size: 14px

                z13places-3:
                    filter:
                        any:
                        - { population: { min: 5000, max: 49999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 12px

                z13places-4:
                    filter:
                        any:
                            - population: false
                            - population: true
                              all:
                                - population: { max: 5000 }
                    draw:
                        text-blend-order:
                            font:
                                size: 12px

            populated-places-osm-z13-z14-no-population:
                filter:
                    all:
                        - source: openstreetmap
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [13, 14]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center
                        visible: *text_visible_populated_places
                        priority: 7
                        font:
                            size: 11px

            populated-places-natural-earth-z13-z14-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [13,14], population: { max: 5000 } }
                draw:
                    text-blend-order:
                        anchor: center
                        font:
                            fill: *text_fill
                            weight: 400

                z13places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            priority: 8
                            interactive: false
                            visible: false

                z13places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            priority: 9
                            visible: *text_visible_populated_places
                            font:
                                size: 13px

                z13places-3-ne:
                    filter: { scalerank: [6,7,8,9,10,11,12] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 10
                            font:
                                size: 12px

            neighborhood-z11:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [11]
                    any:
                        - source: openstreetmap
                        - source: whosonfirst
                          all:
                            - min_zoom: [11]
                            - max_zoom: { min: 12 }
                            - is_landuse_aoi: false
                            #- kind_tile_rank: { max: 6 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 10
                        visible: *text_visible_neighbourhoods_e
                        font:
                            size: 9px
                            weight: 400
                            fill: *text_fill
                            transform: uppercase
                            stroke: { color: *text_stroke, width: 4 }
            neighborhood-z12:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [12]
                    any:
                        - source: openstreetmap
                        - source: whosonfirst
                          all:
                            - min_zoom: [11,12]
                            - max_zoom: { min: 13 }
                            - is_landuse_aoi: false
                            #- kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 10
                        visible: *text_visible_neighbourhoods_e
                        font:
                            size: 10px
                            weight: 400
                            fill: [0.300,0.300,0.300]
                            transform: uppercase
                            # stroke: { color: *text_stroke, width: 2 }
            neighborhood-z13:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [13]
                    any:
                        - source: openstreetmap
                        - source: whosonfirst
                          all:
                            - min_zoom: [11,12,13]
                            - max_zoom: { min: 14 }
                            - is_landuse_aoi: false
                            - kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 10
                        visible: *text_visible_neighbourhoods_e
                        font:
                            size: 11px
                            weight: 400
                            fill: [0.35,0.35,0.35]
                            transform: uppercase
                            # stroke: { color: *text_stroke, width: 2 }
            neighborhood-z14:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [14]
                    any:
                        - source: openstreetmap
                        - source: whosonfirst
                          all:
                            - min_zoom: [11,12,13,14]
                            - max_zoom: { min: 15 }
                            - is_landuse_aoi: false
                            - kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 12
                        visible: *text_visible_neighbourhoods
                        font:
                            size: 13px
                            weight: 400
                            fill: [0.000,0.000,0.000,0.500]
                            transform: uppercase
                            # stroke: { color: *text_stroke, width: 3 }
            neighborhood-z15:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [15]
                    any:
                        - source: openstreetmap
                        - source: whosonfirst
                          all:
                            - min_zoom: [11,12,13,14,15]
                            - max_zoom: { min: 16 }
                            - is_landuse_aoi: false
                            - kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 12
                        visible: *text_visible_neighbourhoods
                        font:
                            size: 16px
                            weight: 300
                            fill: [0.000,0.000,0.000,0.480]
                            transform: uppercase
                            # stroke: { color: *text_stroke, width: 3 }
                z15-new:
                    filter:
                        all:
                            - min_zoom: 15
                    draw:
                        text-blend-order:
                            priority: 19
                            font:
                                size: 13px
            neighborhood-z16:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [16]
                    any:
                        - source: openstreetmap
                        - source: whosonfirst
                          all:
                            - min_zoom: [11,12,13,14,15,16]
                            - max_zoom: { min: 17 }
                            - is_landuse_aoi: false
                            - kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        visible: *text_visible_neighbourhoods
                        priority: 18
                        font:
                            size: 17px
                            weight: 300
                            fill: [0.000,0.000,0.000,0.400]
                            transform: uppercase
                            # stroke: { color: *text_stroke, width: 3 }
